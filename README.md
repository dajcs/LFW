# LFW
Lens Flare Wizard

version 0.1

The aim of this project is to write a python script which will generate Lens Flare effects and apply them on top of existing images with the intent to create a training set of images with and without Lens Flare effects to be used in training a Computer Vision model.

The Lens Flare effects will be generated by [Blender](https://www.blender.org/) using the [Flares Wizard](https://blendermarket.com/products/flares-wizard) add-on.

The scripts have been tested in Windows11 on Blender 3.6.5 together with Flares Wizard 3.0, but in principle it should work with Blender 4.0 & Flares Wizard 3.1 combination.

Install Blender together with the Flares Wizard add-on.  Blender will be started from command line, so it is a good idea to add the Blender executable to the path.

The scripts help message can be displayed by commands:
```
blender --python lf_setup.py -- --help
blender --python lf_gen.py -- --help
```

and this is the help message:

```
usage:
blender [-b] --python lf_[setup|gen].py -- [LFW options]

LFW scripts: lf_setup.py and lf_gen.py is used to generate Lens Flare effects using Blender with
Lens Flare Wizard add-on.
It is recommended to add Blender program location to the path and start Blender via cmd line from
a terminal window, as shown.
The parameters before token "--" are interpreted by Blender's python; parameters after token "--"
are used by the LFW scripts.
This help message can be displayed by command:
blender --python lf_setup.py -- --help

options:
  -h, --help            show this help message and exit
  -b, --background      background (headless) blender execution (parameter handled by Blender)
  -P PYTHON, --python PYTHON
                        path to python script executed by blender (parameter handled by Blender)
Use "--" to separate Blender and LFW script parameters. After "--" all the parameters will be
parsed by the LFW scripts
  -ri REF_IMAGE, --ref_image REF_IMAGE
                        path to image used as a background for lens flares setup or getting
resolution by lf_gen
  -lf LF_PARAMS, --lf_params LF_PARAMS
                        path to json file storing lens flares settings
  -s SOURCE, --source SOURCE
                        path to source directory of original images, or int representing nr of
images to generate LF on black background
  -o OUTPUT, --output OUTPUT
                        path to output directory for images with LF, it will be created if it
doesn't exist
  -rx RES_X, --res_x RES_X
                        resolution X (width, default 1920), of the output images, considered when
no ref_image and source is a number (generating LF on black background)
  -ry RES_Y, --res_y RES_Y
                        resolution Y (height, default 1080) of the output images, considered when
no ref_image and source is a number (generating LF on black background)
  -oi OUTSIDE_IMAGE, --outside_image OUTSIDE_IMAGE
                        percentage of how far can move the LF effect origin outside the image
borders. Default 20 percent of the image size.

Example:
blender --python lf_setup.py -- --ref_image LTV.png
can be used to prepare the json file containing the lens flare effects.
This starts with displaying the ref_image LTV.png, on top of it a basic LF effect.
Add and/or adjust LF elements and save LF to a json file - as described in the terminal window.
Example:
blender --python lf_gen.py -- --lf_params my_lf_params.json --source images --output outimages
is used to add LF effects specified in my_lf_params.json to images in "images" directory and save
them to "outimages" directory.
```

`lf_setup.py` starts by loading `lf_basic.json` - if no other file is specified.  This file adds a Blank LF and a single STREAKS element.  Feel free to add further elements and adjust their properties.  Current version supports a single LF, but arbitrary number of elements can be added which gives the possibility to reproduce almost any LF effect.

When visually pleased with the effect, save json file as described in the cmd terminal:

```
    Press "N", slect "Lens Flares" in the side menu
    Please adjust the Lens Flare effects for your project needs

    When finished adjustments, select Scripting workspace (top menu right)
    Save settings by entering the commands below into Blender's Python console (left middle window)

    import utils
    utils.save('filename.json')
```

The saved json file can be further edited if we want a variability of the LF effects.  E.g. we have a .json file with a STREAK element:

```json
[
    {
        "name": "ELEMENT",
        "ui_name": "Streaks",
        "type": "STREAKS",
        "flare": "LF",
        "scale_x": 8.0,
        "scale_y": 0.4000000059604645,
        "light_falloff": 2.630000114440918,
        "streaks_count": 3,
        "color": [
            0.06963802129030228,
            1.0,
            0.1308511197566986,
            1.0
        ],
        "use_global_color": 0.7333333492279053,
        "intensity": 0.7000000476837158
    }
]
```

This can be edited as follows:

```json
[
    {
        "name": "ELEMENT",
        "ui_name": "Streaks",
        "type": "STREAKS",
        "flare": "LF",
        "scale_x": 8.0,
        "scale_y": 0.4000000059604645,
        "light_falloff": 2.630000114440918,
        "streaks_count": [1, 5],   // number replaced by 2 element list
        "color": [
            0.06963802129030228,
            1.0,
            [0.05, 0.5],           // number replaced by 2 element list
            1.0
        ],
        "use_global_color": 0.7333333492279053,
        "intensity": 0.7000000476837158
    }
]
```

individual numbers can be replaced by a two element list and the script will generate a sample between the two values (inclusive if the value is integer)

See further examples in `lf_delta.json`

`lf_gen.py` then can be used the generate the LF effects on top of existing images when the --source points to a directory with the images, or on top of black background when the --source is an integer - this many images will be generated.